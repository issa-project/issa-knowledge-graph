#!/bin/bash
# Query all unique DBpedia URIs from the annotations generated by DBpedia Spotlight

# Set here the number of URIs to retrieve
#size=65871

query=$(cat << EOF
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX oa: <http://www.w3.org/ns/oa#>
SELECT (count(distinct ?uri) as ?cnt)
FROM <http://data-issa.cirad.fr/graph/dbpedia-spotlight-nes>
FROM <http://data-issa.cirad.fr/graph/dbpedia-named-entities>
WHERE { ?annot oa:hasBody ?uri. 
        FILTER NOT EXISTS {GRAPH <http://data-issa.cirad.fr/graph/dbpedia-named-entities> {?uri rdfs:label ?dbpLabel .}}}
EOF
)

size=$(curl -H "accept: text/csv" \
            --data-urlencode "query=${query}" \
     	    http://localhost:8890/sparql \
			| grep -o -E '[0-9]+' )


# Max number of URIs to retrieve at once (limit of the SPARQL endpoint)
limit=10000

query=$(cat << EOF
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX oa: <http://www.w3.org/ns/oa#>
SELECT DISTINCT ?uri
FROM <http://data-issa.cirad.fr/graph/dbpedia-spotlight-nes>
FROM <http://data-issa.cirad.fr/graph/dbpedia-named-entities>
WHERE { ?annot oa:hasBody ?uri. 
        FILTER NOT EXISTS {GRAPH <http://data-issa.cirad.fr/graph/dbpedia-named-entities> {?uri rdfs:label ?dbpLabel .}}}
LIMIT ${limit}
OFFSET		
EOF
)


result=dbpedia-ne-uris.txt
echo -n "" > $result

resulttmp=/tmp/sparql-response-$$.ttl
echo -n "" > $resulttmp

offset=0
while [ "$offset" -lt "$size" ]
do
    echo "Retrieving URIs starting at $offset..."
    curl -H "accept: text/csv" \
		--data-urlencode "query=${query}${offset}" \
     	http://localhost:8890/sparql \
        | grep -v '"uri"' | sed 's|"||g' >> $resulttmp
     offset=$(($offset + $limit))
     
done

cat $resulttmp | sort | uniq > $result
rm $resulttmp
