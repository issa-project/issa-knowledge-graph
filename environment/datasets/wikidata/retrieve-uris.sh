#!/bin/bash
# Authors: Anna BOBASHEVA, University Cote d'Azur, Inria
#
# Licensed under the Apache License, Version 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
# Query all unique URIs from the abstracts' annotations generated by entity-fishing

# Environment definitions
. ../../../env.sh

VIRTUOSO_PORT=${VIRTUOSO_HOST_HTTP_PORT:-8890}
ISSA_NS=${ISSA_NAMESPACE:-http://data-issa.cirad.fr/}

NES_GRAPH=${ISSA_NS}graph/entity-fishing-nes
WD_GRAPH=${ISSA_NS}graph/wikidata-named-entities

# Compute the number of URIs to retrieve
query=$(cat retrieve-uris-count.sparql)
query=${query//\{\{NES_GRAPH\}\}/$NES_GRAPH}
query=${query//\{\{WD_GRAPH\}\}/$WD_GRAPH}

echo "Retrieving number of unique URIs..."
echo
echo "${query}"

size=$(curl -H "accept: text/csv" \
            --data-urlencode "query=${query}" \
     	    http://localhost:$VIRTUOSO_PORT/sparql \
			| grep -o -E '[0-9]+' )
echo
echo "*** Number of unique URIs to retrieve: $size ***"


# Max number of URIs to retrieve at once
limit=10000

query_tpl=$(cat retrieve-uris.sparql)
query_tpl=${query_tpl//\{\{NES_GRAPH\}\}/$NES_GRAPH}
query_tpl=${query_tpl//\{\{WD_GRAPH\}\}/$WD_GRAPH}

result=wikidata-ne-uris.txt
resulttmp=/tmp/sparql-response-$$.ttl
echo -n "" > $resulttmp

offset=0

while [ "$offset" -lt "$size" ]
do
    query=$query_tpl
    query=${query//\{\{limit\}\}/$limit}
    query=${query//\{\{offset\}\}/$offset}

    echo
    echo "*** Retrieving URIs starting at $offset..."
    echo "${query}"

    curl -H "accept: text/csv" \
		--data-urlencode "query=${query}" \
     	http://localhost:$VIRTUOSO_PORT/sparql \
        | grep -v '"uri"' | sed 's|"||g' >> $resulttmp
     offset=$(($offset + $limit))
     
done

cat $resulttmp | sort | uniq > $result
rm $resulttmp
